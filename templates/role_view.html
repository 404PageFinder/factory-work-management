{% extends "base.html" %}
{% block content %}

<section class="page-header">
    <div>
        <h2>{{ role|pretty }} Panel</h2>
        <p class="page-subtitle">
            Orders currently assigned to <strong>{{ role|pretty }}</strong>
        </p>
    </div>
    <div class="page-header-actions">
        <a href="/" class="btn btn-ghost">‚Üê Back to Dashboard</a>
    </div>
</section>

{% if role.value == 'manufacturing' %}
<section class="panel">
    <div class="panel-header">
        <h3>üì¶ Raise Procurement Request</h3>
        <p class="panel-subtitle">
            Create a request for Procurement; optionally link it to a Manufacturing task
        </p>
    </div>

    <form action="/procurement-request" method="post" class="form">
        <div class="form-field">
            <label for="pr_title">üìù Title</label>
            <input id="pr_title" type="text" name="title" required
                   placeholder="e.g. Need SS rods 10mm ¬∑ 200kg">
        </div>

        <div class="form-field">
            <label for="pr_desc">üí¨ Description</label>
            <textarea id="pr_desc" name="description" rows="3"
                      placeholder="Add any technical or delivery requirements"></textarea>
        </div>

        <div class="form-field">
            <label for="pr_quantity">üî¢ Quantity</label>
            <input id="pr_quantity" type="number" name="quantity" min="1" value="1" required>
        </div>

        <div class="form-field">
            <label for="pr_unit">üìè Unit</label>
            <select id="pr_unit" name="unit">
                <option value="KG">KG</option>
                <option value="Count">Count</option>
                <option value="Litres">Litres</option>
            </select>
        </div>

        <div class="form-field">
            <label for="dependency_workorder_id">üîó Dependency Task (optional)</label>
            <select id="dependency_workorder_id" name="dependency_workorder_id">
                <option value="0">‚Äî No dependency ‚Äî</option>
                {% for o in orders %}
                <option value="{{ o.id }}">{{ o.display_id or ('#' ~ o.id) }} ¬∑ {{ o.title }}</option>
                {% endfor %}
            </select>
            <p class="hint">
                If selected, that task will be marked <strong>Blocked</strong> once approved
            </p>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Submit Request</button>
        </div>
    </form>

    <div class="panel-header" style="margin-top: 32px;">
        <h3>üì¶ My Procurement Requests</h3>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>Request ID</th>
                <th>Title</th>
                <th>Status</th>
                <th>Procurement Task</th>
                <th>Quantity</th>
                <th>Created At</th>
                <th>Decision Time</th>
            </tr>
            </thead>
            <tbody>
            {% for r in manufacturing_reqs %}
            <tr>
                <td><strong>{{ r.display_id or ('#' ~ r.id) }}</strong></td>
                <td><strong>{{ r.title }}</strong></td>
                <td>
                    <span class="pill pill-status-{% if r.status.value == 'approved' %}approved{% elif r.status.value == 'rejected' %}rejected{% else %}new{% endif %}">
                        {{ r.status|pretty }}
                    </span>
                </td>
                <td>
                    {% if r.procurement_workorder %}
                        <strong>{{ r.procurement_workorder.display_id or ('#' ~ r.procurement_workorder.id) }}</strong>
                    {% else %}
                        <span class="muted">‚Äî</span>
                    {% endif %}
                </td>
                <td><strong>{{ r.quantity }}</strong> <span class="muted">{{ r.unit }}</span></td>
                <td>{{ r.created_at.strftime('%Y-%m-%d %H:%M') if r.created_at else '‚Äî' }}</td>
                <td>{{ r.decided_at.strftime('%Y-%m-%d %H:%M') if r.decided_at else '‚Äî' }}</td>
            </tr>
            {% endfor %}
            {% if not manufacturing_reqs %}
            <tr>
                <td colspan="7" class="text-center">No procurement requests raised yet</td>
            </tr>
            {% endif %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

{% if role.value == 'inventory' %}
<!-- Inventory Tabs -->
<section class="panel">
    <div class="panel-header">
        <h3>üè™ Inventory Management</h3>
        <p class="panel-subtitle">
            Manage raw materials and delivery items separately
        </p>
    </div>
    
    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-button" data-tab="delivery" onclick="switchTab('delivery')">
            üì¶ Delivery Items
        </button>
        <button class="tab-button active" data-tab="raw" onclick="switchTab('raw')">
            üß™ Raw Materials
        </button>
        <button class="tab-button" data-tab="packaging" onclick="switchTab('packaging')">
            üì¶ Packaging Materials
        </button>
    </div>

    <!-- Delivery Items Tab -->
    <div id="delivery-tab" class="tab-content" style="display: none;">
        <div class="panel-header" style="border-top: none; padding-top: 0;">
            <h3>üì¶ Delivery Items</h3>
            <p class="panel-subtitle">Items ready for customer delivery (from Packaging)</p>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Status</th>
                    <th>Quantity</th>
                    <th>Packaging Size</th>
                    <th>Order Type</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                {% for o in delivery_items %}
                <tr>
                    <td><strong>{{ o.display_id or ('#' ~ o.id) }}</strong></td>
                    <td title="{{ o.title }}"><strong>{{ o.title }}</strong></td>
                    <td>
                        {% if o.status.value == 'blocked' %}
                            <div class="blocked-indicator">
                                <span class="pill pill-status-blocked">Blocked</span>
                                {% if o.blocked_reason %}
                                <span class="blocked-reason-tooltip" data-reason="{{ o.blocked_reason }}">
                                    ‚ÑπÔ∏è
                                </span>
                                {% endif %}
                            </div>
                        {% else %}
                            <span class="pill pill-status-{{ o.status.value }}">
                                {% if o.status.value == 'new' %}Received{% else %}{{ o.status|pretty }}{% endif %}
                            </span>
                        {% endif %}
                    </td>
                    <td><strong>{{ o.quantity }}</strong> <span class="muted">{{ o.unit }}</span></td>
                    <td>
                        {% if o.packaging_size_gm %}
                            <strong>{{ o.packaging_size_gm }}</strong> <span class="muted">gm</span>
                        {% else %}
                            <span class="muted">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="pill pill-type-{{ o.order_type.value }}">
                            {{ o.order_type|pretty }}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            {% if o.status.value != 'blocked' %}
                                {% for status_val, status_label, btn_class in order_actions.get(o.id, []) %}
                                <form action="/role/{{ role.value }}/update-status" method="post" class="inline-form">
                                    <input type="hidden" name="order_id" value="{{ o.id }}">
                                    <input type="hidden" name="status" value="{{ status_val }}">
                                    <button type="submit" class="btn btn-small btn-{{ btn_class }}">
                                        {{ status_label }}
                                    </button>
                                </form>
                                {% endfor %}
                            {% endif %}
                            
                            {% if o.status.value != 'blocked' %}
                            <button type="button" class="btn btn-small btn-blocked" onclick="openBlockModal({{ o.id }}, '{{ o.title }}')">
                                üö´ Block
                            </button>
                            {% else %}
                            <form action="/role/{{ role.value }}/update-status" method="post" class="inline-form">
                                <input type="hidden" name="order_id" value="{{ o.id }}">
                                <input type="hidden" name="status" value="new">
                                <button type="submit" class="btn btn-small btn-info">
                                    ‚úì Unblock
                                </button>
                            </form>
                            {% endif %}
                            
                            <form action="/role/{{ role.value }}/delete-order" method="post" class="inline-form">
                                <input type="hidden" name="order_id" value="{{ o.id }}">
                                <button type="submit" class="btn btn-small btn-small-secondary" onclick="return confirm('Are you sure?')">
                                    üóëÔ∏è Delete
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% if not delivery_items %}
                <tr>
                    <td colspan="7" class="text-center">No delivery items in inventory yet</td>
                </tr>
                {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Raw Materials Tab -->
    <div id="raw-tab" class="tab-content">
        <div class="panel-header" style="border-top: none; padding-top: 0;">
            <h3>üß™ Raw Materials</h3>
            <p class="panel-subtitle">Raw materials from Procurement and Manufacturing requests</p>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Status</th>
                    <th>Quantity</th>
                    <th>Vendor</th>
                    <th>Order Type</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                {% for o in raw_items %}
                <tr>
                    <td><strong>{{ o.display_id or ('#' ~ o.id) }}</strong></td>
                    <td title="{{ o.title }}"><strong>{{ o.title }}</strong></td>
                    <td>
                        {% if o.status.value == 'blocked' %}
                            <div class="blocked-indicator">
                                <span class="pill pill-status-blocked">Blocked</span>
                                {% if o.blocked_reason %}
                                <span class="blocked-reason-tooltip" data-reason="{{ o.blocked_reason }}">
                                    ‚ÑπÔ∏è
                                </span>
                                {% endif %}
                            </div>
                        {% else %}
                            <span class="pill pill-status-{{ o.status.value }}">
                                {% if o.status.value == 'new' %}Received{% else %}{{ o.status|pretty }}{% endif %}
                            </span>
                        {% endif %}
                    </td>
                    <td><strong>{{ o.quantity }}</strong> <span class="muted">{{ o.unit }}</span></td>
                    <td>
                        {% if o.vendor %}
                            <span class="pill pill-vendor">{{ o.vendor.name }}</span>
                        {% else %}
                            <span class="muted">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="pill pill-type-{{ o.order_type.value }}">
                            {{ o.order_type|pretty }}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            {% if o.status.value != 'blocked' %}
                                {% for status_val, status_label, btn_class in order_actions.get(o.id, []) %}
                                <form action="/role/{{ role.value }}/update-status" method="post" class="inline-form">
                                    <input type="hidden" name="order_id" value="{{ o.id }}">
                                    <input type="hidden" name="status" value="{{ status_val }}">
                                    <button type="submit" class="btn btn-small btn-{{ btn_class }}">
                                        {{ status_label }}
                                    </button>
                                </form>
                                {% endfor %}
                            {% endif %}
                            
                            {% if o.status.value != 'blocked' %}
                            <button type="button" class="btn btn-small btn-blocked" onclick="openBlockModal({{ o.id }}, '{{ o.title }}')">
                                üö´ Block
                            </button>
                            {% else %}
                            <form action="/role/{{ role.value }}/update-status" method="post" class="inline-form">
                                <input type="hidden" name="order_id" value="{{ o.id }}">
                                <input type="hidden" name="status" value="new">
                                <button type="submit" class="btn btn-small btn-info">
                                    ‚úì Unblock
                                </button>
                            </form>
                            {% endif %}
                            
                            <form action="/role/{{ role.value }}/delete-order" method="post" class="inline-form">
                                <input type="hidden" name="order_id" value="{{ o.id }}">
                                <button type="submit" class="btn btn-small btn-small-secondary" onclick="return confirm('Are you sure?')">
                                    üóëÔ∏è Delete
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% if not raw_items %}
                <tr>
                    <td colspan="7" class="text-center">No raw materials in inventory yet</td>
                </tr>
                {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Packaging Materials Tab -->
    <div id="packaging-tab" class="tab-content" style="display: none;">
        <div class="panel-header" style="border-top: none; padding-top: 0;">
            <h3>üì¶ Packaging Materials</h3>
            <p class="panel-subtitle">Packaging materials inventory (boxes, tubs, pouches)</p>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Type</th>
                    <th>Size</th>
                    <th>Status</th>
                    <th>Quantity</th>
                    <th>Vendor</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                {% for o in packaging_items %}
                <tr>
                    <td><strong>{{ o.display_id or ('#' ~ o.id) }}</strong></td>
                    <td>
                        <span class="pill" style="background: rgba(139, 92, 246, 0.2); color: #c4b5fd;">
                            {{ o.packaging_type or 'N/A' }}
                        </span>
                    </td>
                    <td><strong>{{ o.packaging_size or 'N/A' }}</strong></td>
                    <td>
                        {% if o.status.value == 'blocked' %}
                            <div class="blocked-indicator">
                                <span class="pill pill-status-blocked">Blocked</span>
                                {% if o.blocked_reason %}
                                <span class="blocked-reason-tooltip" data-reason="{{ o.blocked_reason }}">
                                    ‚ÑπÔ∏è
                                </span>
                                {% endif %}
                            </div>
                        {% else %}
                            <span class="pill pill-status-{{ o.status.value }}">
                                {% if o.status.value == 'new' %}Received{% else %}{{ o.status|pretty }}{% endif %}
                            </span>
                        {% endif %}
                    </td>
                    <td><strong>{{ o.quantity }}</strong> <span class="muted">{{ o.unit }}</span></td>
                    <td>
                        {% if o.vendor %}
                            <span class="pill pill-vendor">{{ o.vendor.name }}</span>
                        {% else %}
                            <span class="muted">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            {% if o.status.value != 'blocked' %}
                                {% for status_val, status_label, btn_class in order_actions.get(o.id, []) %}
                                <form action="/role/{{ role.value }}/update-status" method="post" class="inline-form">
                                    <input type="hidden" name="order_id" value="{{ o.id }}">
                                    <input type="hidden" name="status" value="{{ status_val }}">
                                    <button type="submit" class="btn btn-small btn-{{ btn_class }}">
                                        {{ status_label }}
                                    </button>
                                </form>
                                {% endfor %}
                            {% endif %}
                            
                            {% if o.status.value != 'blocked' %}
                            <button type="button" class="btn btn-small btn-blocked" onclick="openBlockModal({{ o.id }}, '{{ o.title }}')">
                                üö´ Block
                            </button>
                            {% else %}
                            <form action="/role/{{ role.value }}/update-status" method="post" class="inline-form">
                                <input type="hidden" name="order_id" value="{{ o.id }}">
                                <input type="hidden" name="status" value="new">
                                <button type="submit" class="btn btn-small btn-info">
                                    ‚úì Unblock
                                </button>
                            </form>
                            {% endif %}
                            
                            <form action="/role/{{ role.value }}/delete-order" method="post" class="inline-form">
                                <input type="hidden" name="order_id" value="{{ o.id }}">
                                <button type="submit" class="btn btn-small btn-small-secondary" onclick="return confirm('Are you sure?')">
                                    üóëÔ∏è Delete
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% if not packaging_items %}
                <tr>
                    <td colspan="7" class="text-center">No packaging materials in inventory yet</td>
                </tr>
                {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</section>

{% else %}
<!-- Regular orders view for non-inventory roles -->
<section class="panel table-panel">
    <div class="panel-header">
        <h3>
            {% if role.value == 'procurement' %}
            üõí Procurement Orders
            {% elif role.value == 'manufacturing' %}
            ‚öôÔ∏è Manufacturing Orders
            {% elif role.value == 'qa' %}
            üîç Quality Assurance Orders
            {% elif role.value == 'packaging' %}
            üì¶ Packaging Orders
            {% else %}
            Work Orders
            {% endif %}
        </h3>
        <p class="panel-subtitle">
            {% if role.value == 'procurement' %}
            Procure raw materials from vendors - items go directly to Inventory as raw materials
            {% elif role.value == 'manufacturing' %}
            Manufacturing produces raw material items for QA
            {% elif role.value == 'qa' %}
            Test products and mark as Passed or Failed
            {% elif role.value == 'packaging' %}
            Package completed products - items become delivery items in Inventory
            {% else %}
            Manage and update order status
            {% endif %}
        </p>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Vendor</th>
                <th>Status</th>
                <th>Quantity</th>
                <th>Order Type</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for o in orders %}
            <tr>
                <td><strong>{{ o.display_id or ('#' ~ o.id) }}</strong></td>
                <td title="{{ o.title }}"><strong>{{ o.title }}</strong></td>
                <td>
                    {% if o.vendor %}
                        <span class="pill pill-vendor">{{ o.vendor.name }}</span>
                    {% else %}
                        <span class="muted">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    {% if o.status.value == 'blocked' %}
                        <div class="blocked-indicator">
                            <span class="pill pill-status-blocked">Blocked</span>
                            {% if o.blocked_reason %}
                            <span class="blocked-reason-tooltip" data-reason="{{ o.blocked_reason }}">
                                ‚ÑπÔ∏è
                            </span>
                            {% endif %}
                        </div>
                    {% else %}
                        <span class="pill pill-status-{{ o.status.value }}">
                            {{ o.status|pretty }}
                        </span>
                    {% endif %}
                </td>
                <td><strong>{{ o.quantity }}</strong> <span class="muted">{{ o.unit }}</span></td>
                <td>
                    <span class="pill pill-type-{{ o.order_type.value }}">
                        {{ o.order_type|pretty }}
                    </span>
                </td>
                <td>
                    <div class="action-buttons">
                        {% if o.status.value != 'blocked' %}
                            {% for status_val, status_label, btn_class in order_actions.get(o.id, []) %}
                            <form action="/role/{{ role.value }}/update-status" method="post" class="inline-form">
                                <input type="hidden" name="order_id" value="{{ o.id }}">
                                <input type="hidden" name="status" value="{{ status_val }}">
                                
                                {% if role.value in ['procurement', 'manufacturing', 'qa', 'packaging'] and status_val in ['completed', 'packed', 'procured'] %}
                                <input
                                    type="number"
                                    name="qty_done"
                                    class="inline-qty-input"
                                    min="1"
                                    max="{{ o.quantity }}"
                                    value="{{ o.quantity }}"
                                    placeholder="Qty"
                                    title="Quantity to complete">
                                {% endif %}
                                
                                <button type="submit" class="btn btn-small btn-{{ btn_class }}">
                                    {{ status_label }}
                                </button>
                            </form>
                            {% endfor %}
                        {% endif %}
                        
                        {% if o.status.value != 'blocked' %}
                        <button type="button" class="btn btn-small btn-blocked" onclick="openBlockModal({{ o.id }}, '{{ o.title }}')">
                            üö´ Block
                        </button>
                        {% else %}
                        <form action="/role/{{ role.value }}/update-status" method="post" class="inline-form">
                            <input type="hidden" name="order_id" value="{{ o.id }}">
                            <input type="hidden" name="status" value="new">
                            <button type="submit" class="btn btn-small btn-info">
                                ‚úì Unblock
                            </button>
                        </form>
                        {% endif %}
                        
                        <form action="/role/{{ role.value }}/delete-order" method="post" class="inline-form">
                            <input type="hidden" name="order_id" value="{{ o.id }}">
                            <button type="submit" class="btn btn-small btn-small-secondary" onclick="return confirm('Are you sure you want to delete this order?')">
                                üóëÔ∏è Delete
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
            {% if not orders %}
            <tr>
                <td colspan="7" class="text-center">
                    No work orders assigned to {{ role|pretty }} yet
                </td>
            </tr>
            {% endif %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

<!-- Block Reason Modal -->
<div id="blockModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üö´ Block Order</h3>
            <p class="page-subtitle" id="modalOrderTitle"></p>
        </div>
        <form id="blockForm" action="/role/{{ role.value }}/update-status" method="post">
            <input type="hidden" name="order_id" id="modalOrderId">
            <input type="hidden" name="status" value="blocked">
            
            <div class="form-field">
                <label for="blocked_reason">Reason for blocking:</label>
                <textarea id="blocked_reason" name="blocked_reason" rows="4" required
                          placeholder="Enter the reason why this order is being blocked..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-ghost" onclick="closeBlockModal()">Cancel</button>
                <button type="submit" class="btn btn-danger">Block Order</button>
            </div>
        </form>
    </div>
</div>

<script>
function openBlockModal(orderId, orderTitle) {
    document.getElementById('modalOrderId').value = orderId;
    document.getElementById('modalOrderTitle').textContent = 'Order: ' + orderTitle;
    document.getElementById('blocked_reason').value = '';
    document.getElementById('blockModal').classList.add('active');
}

function closeBlockModal() {
    document.getElementById('blockModal').classList.remove('active');
}

// Close modal on outside click
document.getElementById('blockModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeBlockModal();
    }
});

// Close modal on ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeBlockModal();
    }
});

// Tab switching for inventory
function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(tabName + '-tab').style.display = 'block';
    
    // Add active class to clicked button
    document.querySelector('[data-tab="' + tabName + '"]').classList.add('active');
}

// Default to raw materials tab on page load
document.addEventListener('DOMContentLoaded', function() {
    {% if role.value == 'inventory' %}
    switchTab('raw');
    {% endif %}
});
</script>

{% endblock %}
