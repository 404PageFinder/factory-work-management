{% extends "base.html" %}
{% block content %}

<section class="page-header">
    <div>
        <h2>{{ role|pretty }} Panel</h2>
        <p class="page-subtitle">
            Orders currently assigned to <strong>{{ role|pretty }}</strong>.
        </p>
    </div>
    <div class="page-header-actions">
        <a href="/" class="btn btn-ghost">â† Back to Dashboard</a>
    </div>
</section>

{% if role.value == 'manufacturing' %}
<section class="panel">
    <div class="panel-header">
        <h3>ğŸ“¦ Raise Procurement Request</h3>
        <p class="panel-subtitle">
            Create a request for Procurement; optionally link it to a Manufacturing task.
        </p>
    </div>

    <form action="/procurement-request" method="post" class="form">
        <div class="form-field">
            <label for="pr_title">ğŸ“ Title</label>
            <input id="pr_title" type="text" name="title" required
                   placeholder="e.g. Need SS rods 10mm Â· 200kg">
        </div>

        <div class="form-field">
            <label for="pr_desc">ğŸ’¬ Description</label>
            <textarea id="pr_desc" name="description" rows="3"
                      placeholder="Add any technical or delivery requirements"></textarea>
        </div>

        <div class="form-field">
            <label for="pr_quantity">ğŸ”¢ Quantity</label>
            <input id="pr_quantity" type="number" name="quantity" min="1" value="1" required>
        </div>

        <div class="form-field">
            <label for="pr_unit">ğŸ“ Unit</label>
            <select id="pr_unit" name="unit">
                <option value="KG">KG</option>
                <option value="Count">Count</option>
                <option value="Litres">Litres</option>
            </select>
        </div>

        <div class="form-field">
            <label for="dependency_workorder_id">ğŸ”— Dependency Task (optional)</label>
            <select id="dependency_workorder_id" name="dependency_workorder_id">
                <option value="0">â€” No dependency â€”</option>
                {% for o in orders %}
                <option value="{{ o.id }}">{{ o.display_id or ('#' ~ o.id) }} Â· {{ o.title }}</option>
                {% endfor %}
            </select>
            <p class="hint">
                If selected, that task will be marked <strong>Blocked</strong> with reason:
                â€œWaiting for procurement task &lt;ID&gt;â€ once approved.
            </p>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Submit Request</button>
        </div>
    </form>

    <div class="panel-header" style="margin-top: 24px;">
        <h3>ğŸ“¦ My Procurement Requests</h3>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>Request ID</th>
                <th>Title</th>
                <th>Status</th>
                <th>Procurement Task</th>
                <th>Created At</th>
                <th>Decision Time</th>
            </tr>
            </thead>
            <tbody>
            {% for r in manufacturing_reqs %}
            <tr>
                <td>{{ r.display_id or ('#' ~ r.id) }}</td>
                <td>{{ r.title }}</td>
                <td>
                    <span class="pill {% if r.status.value == 'approved' %}pill-status-approved{% elif r.status.value == 'rejected' %}pill-status-rejected{% else %}pill-status-new{% endif %}">
                        {{ r.status|pretty }}
                    </span>
                </td>
                <td>
                    {% if r.procurement_workorder %}
                        {{ r.procurement_workorder.display_id or ('#' ~ r.procurement_workorder.id) }}
                    {% else %}
                        â€”
                    {% endif %}
                </td>
                <td>{{ r.created_at.strftime('%Y-%m-%d %H:%M') if r.created_at else 'â€”' }}</td>
                <td>{{ r.decided_at.strftime('%Y-%m-%d %H:%M') if r.decided_at else 'â€”' }}</td>
            </tr>
            {% endfor %}
            {% if not manufacturing_reqs %}
            <tr>
                <td colspan="6" class="text-center">No procurement requests raised yet.</td>
            </tr>
            {% endif %}
            </tbody>
        </table>
    </div>
</section>
{% endif %}

<section class="panel table-panel">
    <div class="panel-header">
        <h3>
            {% if role.value == 'procurement' %}
            ğŸ›’ Procurement Orders
            {% elif role.value == 'manufacturing' %}
            âš™ï¸ Manufacturing Orders
            {% elif role.value == 'qa' %}
            ğŸ” Quality Assurance Orders
            {% elif role.value == 'packaging' %}
            ğŸ“¦ Packaging Orders
            {% elif role.value == 'inventory' %}
            ğŸª Inventory Orders
            {% else %}
            Work Orders
            {% endif %}
        </h3>
        <p class="panel-subtitle">
            {% if role.value == 'qa' %}
            Test products and mark as Passed or Failed
            {% elif role.value == 'packaging' %}
            Package completed products
            {% elif role.value == 'inventory' %}
            Manage stock - shelf, shipping, and expiry
            {% else %}
            Manage and update order status
            {% endif %}
        </p>
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Description</th>
                <th>Vendor</th>
                <th>Quantity</th>
                <th>Status</th>
                <th>Change Status</th>
            </tr>
            </thead>
            <tbody>
            {% for o in orders %}
            <tr>
                <td><strong>{{ o.display_id or ('#' ~ o.id) }}</strong></td>
                <td><strong>{{ o.title }}</strong></td>
                <td>
                    {% if o.status.value == 'blocked' %}
                        <span class="pill pill-status-blocked">Blocked</span>
                        {% if o.description %}
                            <span class="blocked-reason">{{ o.description }}</span>
                        {% else %}
                            <span class="blocked-reason">Waiting for procurement</span>
                        {% endif %}
                    {% else %}
                        {{ o.description or 'â€”' }}
                    {% endif %}
                </td>
                <td>
                    {% if o.vendor %}
                        <span class="pill pill-vendor">{{ o.vendor.name }}</span>
                    {% else %}
                        <span class="muted">â€”</span>
                    {% endif %}
                </td>
                <td><strong>{{ o.quantity }}</strong> <span class="muted">{{ o.unit }}</span></td>
                <td>
                    <span class="pill {{ 'pill-status-' + o.status.value }}">
                        {% if o.assigned_role.value == 'inventory' and o.status.value == 'new' %}
                            Received
                        {% else %}
                            {{ o.status|pretty }}
                        {% endif %}
                    </span>
                </td>
                <td>
                    <form action="/role/{{ role.value }}/update-status" method="post" class="inline-form">
                        <input type="hidden" name="order_id" value="{{ o.id }}">
                        <select name="status">
                            {% for value, label in status_options %}
                            <option value="{{ value }}" {% if o.status.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                            {% endfor %}
                        </select>

                        {% if role.value in ['procurement', 'manufacturing', 'qa', 'packaging'] %}
                        <input
                            type="number"
                            name="qty_done"
                            class="inline-qty-input"
                            min="1"
                            max="{{ o.quantity }}"
                            value="{{ o.quantity }}"
                            placeholder="Qty">
                        {% endif %}

                        <button type="submit" class="btn btn-small">âœ“ Update</button>
                    </form>

                    <form action="/role/{{ role.value }}/delete-order" method="post" class="inline-form" style="margin-top: 4px;">
                        <input type="hidden" name="order_id" value="{{ o.id }}">
                        <button type="submit" class="btn btn-small-secondary">ğŸ—‘ Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
            {% if not orders %}
            <tr>
                <td colspan="7" class="text-center">
                    No work orders assigned to {{ role|pretty }} yet.
                </td>
            </tr>
            {% endif %}
            </tbody>
        </table>
    </div>
</section>

{% endblock %}
