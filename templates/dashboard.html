{% extends "base.html" %}
{% block content %}

<section class="page-header">
    <div>
        <h2>ğŸ­ Operations Overview</h2>
        <p class="page-subtitle">
            Real-time status of all work orders across departments
        </p>
    </div>
</section>

<section class="grid-main">
    <!-- Metrics (clickable tiles) -->
    <div class="panel">
        <div class="panel-header">
            <h3>ğŸ“Š Work Order Metrics</h3>
            <p class="panel-subtitle">Click on any metric to filter orders</p>
        </div>

        <div class="metrics-grid">
            <a href="/" class="metric-card metric-neutral {% if not selected_status %}metric-active{% endif %}">
                <span class="metric-label">ğŸ”¢ All Orders</span>
                <span class="metric-value">{{ stats.total }}</span>
            </a>

            <a href="/?status=new" class="metric-card metric-info {% if selected_status and selected_status.value == 'new' %}metric-active{% endif %}">
                <span class="metric-label">âœ¨ New</span>
                <span class="metric-value">{{ stats.new }}</span>
            </a>

            <a href="/?status=in_progress" class="metric-card metric-warning {% if selected_status and selected_status.value == 'in_progress' %}metric-active{% endif %}">
                <span class="metric-label">âš™ï¸ In Progress</span>
                <span class="metric-value">{{ stats.in_progress }}</span>
            </a>

            <a href="/?status=blocked" class="metric-card metric-danger {% if selected_status and selected_status.value == 'blocked' %}metric-active{% endif %}">
                <span class="metric-label">â›” Blocked</span>
                <span class="metric-value">{{ stats.blocked }}</span>
            </a>

            <a href="/?status=completed" class="metric-card metric-success {% if selected_status and selected_status.value == 'completed' %}metric-active{% endif %}">
                <span class="metric-label">âœ… Completed</span>
                <span class="metric-value">{{ stats.completed }}</span>
            </a>

            <a href="/?status=rejected" class="metric-card metric-danger-soft {% if selected_status and selected_status.value == 'rejected' %}metric-active{% endif %}">
                <span class="metric-label">âŒ Rejected</span>
                <span class="metric-value">{{ stats.rejected }}</span>
            </a>
        </div>
    </div>

    <!-- Create order -->
    <div class="panel">
        <div class="panel-header">
            <h3>â• Create Work Order</h3>
            <p class="panel-subtitle">
                Assign tasks to different departments
            </p>
        </div>
        <form action="/create-order" method="post" class="form">
            <div class="form-field">
                <label for="title">ğŸ“ Title</label>
                <input id="title" type="text" name="title" required
                       placeholder="e.g. Procure SS Sheets Â· 2mm Â· 500kg">
            </div>

            <div class="form-field">
                <label for="description">ğŸ’¬ Description</label>
                <textarea id="description" name="description" rows="3"
                          placeholder="Short description or special instructions"></textarea>
            </div>

            <div class="form-field">
                <label for="assigned_role">ğŸ‘¥ Assign To</label>
                <select id="assigned_role" name="assigned_role">
                    <option value="procurement">ğŸ›’ Procurement</option>
                    <option value="manufacturing">âš™ï¸ Manufacturing</option>
                    <option value="qa">ğŸ” Quality</option>
                    <option value="packaging">ğŸ“¦ Packaging</option>
                    <option value="inventory">ğŸª Inventory</option>
                </select>
            </div>

            <div class="form-field">
                <label for="quantity">ğŸ”¢ Quantity</label>
                <input id="quantity" type="number" name="quantity" min="1" value="1">
            </div>

            <div class="form-field">
                <label for="unit">ğŸ“ Unit</label>
                <select id="unit" name="unit">
                    <option value="KG">KG</option>
                    <option value="Count">Count</option>
                    <option value="Litres">Litres</option>
                </select>
            </div>

            <div class="form-field" id="vendor-field">
                <label for="vendor_id">
                    ğŸ¢ Vendor <span class="hint">(optional, only for Procurement)</span>
                </label>
                <select id="vendor_id" name="vendor_id">
                    <option value="0">â€” No vendor â€”</option>
                    {% for v in vendors %}
                    <option value="{{ v.id }}">{{ v.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Create</button>
            </div>
        </form>
    </div>
</section>

<section class="panel table-panel">
    <div class="panel-header">
        <h3>ğŸ“‹ Work Orders</h3>
        <p class="panel-subtitle">
            Latest 50 work orders across all departments
        </p>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Team</th>
                <th>Status</th>
                <th>Vendor</th>
                <th>Quantity</th>
                <th>Created At</th>
            </tr>
            </thead>
            <tbody>
            {% for o in orders %}
            <tr>
                <td><strong>{{ o.display_id or ('#' ~ o.id) }}</strong></td>
                <td><strong>{{ o.title }}</strong></td>
                <td>
                    {% if o.assigned_role.value == 'procurement' %}
                    <span class="pill pill-role-procurement">{{ o.assigned_role|pretty }}</span>
                    {% elif o.assigned_role.value == 'manufacturing' %}
                    <span class="pill pill-role-manufacturing">{{ o.assigned_role|pretty }}</span>
                    {% elif o.assigned_role.value == 'qa' %}
                    <span class="pill pill-role-qa">{{ o.assigned_role|pretty }}</span>
                    {% elif o.assigned_role.value == 'packaging' %}
                    <span class="pill pill-role-packaging">{{ o.assigned_role|pretty }}</span>
                    {% elif o.assigned_role.value == 'inventory' %}
                    <span class="pill pill-role-inventory">{{ o.assigned_role|pretty }}</span>
                    {% else %}
                    <span class="pill">{{ o.assigned_role|pretty }}</span>
                    {% endif %}
                </td>
                <td>
                    <span class="pill {{ 'pill-status-' + o.status.value }}">
                        {% if o.assigned_role.value == 'inventory' and o.status.value == 'new' %}
                            Received
                        {% else %}
                            {{ o.status|pretty }}
                        {% endif %}
                    </span>
                </td>
                <td>
                    {% if o.vendor %}
                        <span class="pill pill-vendor">{{ o.vendor.name }}</span>
                    {% else %}
                        <span class="muted">â€”</span>
                    {% endif %}
                </td>
                <td>
                    <strong>{{ o.quantity }}</strong>
                    <span class="muted">{{ o.unit }}</span>
                </td>
                <td>{{ o.created_at.strftime('%Y-%m-%d %H:%M') if o.created_at else 'â€”' }}</td>
            </tr>
            {% endfor %}
            {% if not orders %}
            <tr>
                <td colspan="7" class="text-center">No work orders yet.</td>
            </tr>
            {% endif %}
            </tbody>
        </table>
    </div>
</section>

<section class="panel">
    <div class="panel-header">
        <h3>ğŸ“¦ Procurement Requests from Manufacturing</h3>
        <p class="panel-subtitle">
            Requests raised by Manufacturing that require Procurement + Management review
        </p>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>Request ID</th>
                <th>Title</th>
                <th>Qty</th>
                <th>Unit</th>
                <th>Dependency Task</th>
                <th>Status</th>
                <th>Vendor</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for r in pending_reqs %}
            <tr>
                <td>{{ r.display_id or ('#' ~ r.id) }}</td>
                <td>{{ r.title }}</td>
                <td>{{ r.quantity }}</td>
                <td>{{ r.unit }}</td>
                <td>
                    {% if r.dependency_workorder_id %}
                        #{{ r.dependency_workorder_id }}
                    {% else %}
                        â€”
                    {% endif %}
                </td>
                <td>
                    <span class="pill pill-status-new">{{ r.status|pretty }}</span>
                </td>
                <td>
                    <!-- vendor selected at approval time -->
                    <span class="muted">Select on approve</span>
                </td>
                <td>
                    <form action="/procurement-request/{{ r.id }}/approve" method="post" class="inline-form">
                        <select name="vendor_id">
                            <option value="0">Choose vendorâ€¦</option>
                            {% for v in vendors %}
                            <option value="{{ v.id }}">{{ v.name }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-small">Approve</button>
                    </form>
                    <form action="/procurement-request/{{ r.id }}/reject" method="post" class="inline-form">
                        <button type="submit" class="btn btn-small-secondary">Reject</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
            {% if not pending_reqs %}
            <tr>
                <td colspan="8" class="text-center">No pending requests from Manufacturing.</td>
            </tr>
            {% endif %}
            </tbody>
        </table>
    </div>

    <div class="panel-footer">
        <p class="panel-subtitle">
            Flow: <span class="pill pill-role-manufacturing">Manufacturing</span>
            <span style="color: #a0aec0;">â†’</span>
            <span class="pill pill-role-management">Management</span>
            <span style="color: #a0aec0;">â†’</span>
            <span class="pill pill-role-procurement">Procurement</span>
            <span style="color: #a0aec0;">â†’</span>
            <span class="pill pill-role-manufacturing">Manufacturing</span>
            <span style="color: #a0aec0;">â†’</span>
            <span class="pill pill-role-qa">Quality</span>
            <span style="color: #a0aec0;">â†’</span>
            <span class="pill pill-role-packaging">Packaging</span>
            <span style="color: #a0aec0;">â†’</span>
            <span class="pill pill-role-inventory">Inventory</span>
        </p>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const roleSelect = document.getElementById('assigned_role');
    const vendorField = document.getElementById('vendor-field');

    if (!roleSelect || !vendorField) return;

    function updateVendorVisibility() {
        if (roleSelect.value === 'procurement') {
            vendorField.style.display = '';
        } else {
            vendorField.style.display = 'none';
        }
    }

    roleSelect.addEventListener('change', updateVendorVisibility);
    updateVendorVisibility();
});
</script>

{% endblock %}
