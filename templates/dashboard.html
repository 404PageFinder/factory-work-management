{% extends "base.html" %}
{% block content %}

<section class="page-header">
    <div>
        <h2>üè≠ Operations Overview</h2>
        <p class="page-subtitle">
            Real-time status of all work orders across departments
        </p>
    </div>
</section>

<section class="grid-main">
    <!-- Metrics -->
    <div class="panel">
        <div class="panel-header">
            <h3>üìä Work Order Metrics</h3>
            <p class="panel-subtitle">Click on any metric to filter orders</p>
        </div>

        <div class="metrics-grid">
            <a href="/" class="metric-card metric-neutral {% if not selected_status %}metric-active{% endif %}">
                <span class="metric-label">üî¢ All Orders</span>
                <span class="metric-value">{{ stats.total }}</span>
            </a>

            <a href="/?status=new" class="metric-card metric-info {% if selected_status and selected_status.value == 'new' %}metric-active{% endif %}">
                <span class="metric-label">‚ú® New</span>
                <span class="metric-value">{{ stats.new }}</span>
            </a>

            <a href="/?status=in_progress" class="metric-card metric-warning {% if selected_status and selected_status.value == 'in_progress' %}metric-active{% endif %}">
                <span class="metric-label">‚öôÔ∏è In Progress</span>
                <span class="metric-value">{{ stats.in_progress }}</span>
            </a>

            <a href="/?status=blocked" class="metric-card metric-danger {% if selected_status and selected_status.value == 'blocked' %}metric-active{% endif %}">
                <span class="metric-label">‚õî Blocked</span>
                <span class="metric-value">{{ stats.blocked }}</span>
            </a>

            <a href="/?status=completed" class="metric-card metric-success {% if selected_status and selected_status.value == 'completed' %}metric-active{% endif %}">
                <span class="metric-label">‚úÖ Completed</span>
                <span class="metric-value">{{ stats.completed }}</span>
            </a>

            <a href="/?status=rejected" class="metric-card metric-danger-soft {% if selected_status and selected_status.value == 'rejected' %}metric-active{% endif %}">
                <span class="metric-label">‚ùå Rejected</span>
                <span class="metric-value">{{ stats.rejected }}</span>
            </a>
        </div>
    </div>

    <!-- Create order -->
    <div class="panel">
        <div class="panel-header">
            <h3>‚ûï Create Work Order</h3>
            <p class="panel-subtitle">
                Assign tasks to different departments
            </p>
        </div>
        <form action="/create-order" method="post" class="form">
            <!-- Assign To - MOVED TO TOP -->
            <div class="form-field">
                <label for="assigned_role">üë• Assign To</label>
                <select id="assigned_role" name="assigned_role">
                    <option value="procurement">üõí Procurement</option>
                    <option value="manufacturing">‚öôÔ∏è Manufacturing</option>
                    <option value="qa">üîç Quality</option>
                    <option value="packaging">üì¶ Packaging</option>
                    <option value="inventory">üè™ Inventory</option>
                </select>
            </div>

            <!-- Procurement Order Type (only shown for Procurement) -->
            <div class="form-field" id="procurement-type-field" style="display: none;">
                <label for="procurement_order_type">üì¶ Procurement Order Type</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="proc_raw" name="procurement_order_type" value="raw_material" checked>
                        <label for="proc_raw">üß™ Raw Material</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="proc_packaging" name="procurement_order_type" value="packaging">
                        <label for="proc_packaging">üì¶ Packaging</label>
                    </div>
                </div>
            </div>

            <!-- Packaging Type and Size (only shown for Packaging procurement) -->
            <div class="form-field" id="packaging-type-field" style="display: none;">
                <label for="packaging_type">üì¶ Packaging Type</label>
                <select id="packaging_type" name="packaging_type">
                    <option value="">Select Type</option>
                    <option value="Cardboard boxes">üì¶ Cardboard boxes</option>
                    <option value="Tubs">ü•´ Tubs</option>
                    <option value="Pouches">üëù Pouches</option>
                </select>
            </div>

            <div class="form-field" id="packaging-size-field" style="display: none;">
                <label for="packaging_size">üìè Size</label>
                <select id="packaging_size" name="packaging_size">
                    <option value="">Select Size</option>
                </select>
            </div>

            <!-- Order Category: New or Existing -->
            <div class="form-field">
                <label for="order_category">üìÇ Order Category</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="category_existing" name="order_category" value="existing" checked>
                        <label for="category_existing">üîÑ Existing</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="category_new" name="order_category" value="new">
                        <label for="category_new">‚ú® New</label>
                    </div>
                </div>
                <p class="hint">Existing: Use recipe/standard order | New: Custom order with title</p>
            </div>

            <!-- Title (shown only for New) -->
            <div class="form-field" id="title-field" style="display: none;">
                <label for="title">üìù Title</label>
                <input id="title" type="text" name="title"
                       placeholder="e.g. Procure SS Sheets ¬∑ 2mm ¬∑ 500kg">
            </div>

            <!-- Description (shown only for New) -->
            <div class="form-field" id="description-field" style="display: none;">
                <label for="description">üí¨ Description</label>
                <textarea id="description" name="description" rows="3"
                          placeholder="Short description or special instructions"></textarea>
            </div>

            <div class="form-field">
                <label for="order_type">üìã Order Type</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="type_instant" name="order_type" value="instant" checked>
                        <label for="type_instant">‚ö° Instant</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="type_bulk" name="order_type" value="bulk">
                        <label for="type_bulk">üì¶ Bulk</label>
                    </div>
                </div>
            </div>

            <div class="form-field">
                <label for="quantity">üî¢ Quantity</label>
                <input id="quantity" type="number" name="quantity" min="1" value="1">
            </div>

            <div class="form-field">
                <label for="unit">üìè Unit</label>
                <select id="unit" name="unit">
                    <option value="Count">Count</option>
                    <option value="KG">KG</option>
                    <option value="Litres">Litres</option>
                </select>
            </div>

            <div class="form-field" id="recipe-field" style="display: none;">
                <label for="recipe_id">
                    üìñ Recipe <span class="hint">(for Manufacturing)</span>
                </label>
                <select id="recipe_id" name="recipe_id">
                    <option value="0">‚Äî No recipe ‚Äî</option>
                    {% for r in recipes %}
                    <option value="{{ r.id }}">{{ r.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-field" id="vendor-field" style="display: none;">
                <label for="vendor_id">
                    üè¢ Vendor <span class="hint">(for Procurement)</span>
                </label>
                <select id="vendor_id" name="vendor_id">
                    <option value="0">‚Äî No vendor ‚Äî</option>
                    {% for v in vendors %}
                    <option value="{{ v.id }}">{{ v.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Packaging Size -->
            <div class="form-field">
                <label for="packaging_size_gm">üì¶ Packaging Size (gm)</label>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <input type="number" 
                           id="packaging_size_gm" 
                           name="packaging_size_gm" 
                           min="10" 
                           max="1000" 
                           step="5" 
                           value="50"
                           style="width: 150px;">
                    <span class="muted">gm (10-1000, steps of 5)</span>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Create Order</button>
            </div>
        </form>
    </div>
</section>

<!-- CSV Import Section -->
<section class="panel">
    <div class="panel-header">
        <h3>üì• Import Data</h3>
        <p class="panel-subtitle">
            Quickly onboard data from CSV files
        </p>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
        <div style="background: #1e293b; padding: 16px; border-radius: 8px; border: 2px solid #334155;">
            <h4 style="color: #93c5fd; margin-bottom: 8px;">üõí Procurement Orders</h4>
            <form action="/import-procurement" method="post" enctype="multipart/form-data" style="margin-top: 12px;">
                <input type="file" name="file" accept=".csv" required style="margin-bottom: 8px; font-size: 13px;">
                <button type="submit" class="btn btn-small btn-primary">Upload</button>
            </form>
        </div>
        
        <div style="background: #1e293b; padding: 16px; border-radius: 8px; border: 2px solid #334155;">
            <h4 style="color: #fbbf24; margin-bottom: 8px;">üìñ Recipes</h4>
            <form action="/import-recipes" method="post" enctype="multipart/form-data" style="margin-top: 12px;">
                <input type="file" name="file" accept=".csv" required style="margin-bottom: 8px; font-size: 13px;">
                <button type="submit" class="btn btn-small btn-primary">Upload</button>
            </form>
        </div>
        
        <div style="background: #1e293b; padding: 16px; border-radius: 8px; border: 2px solid #334155;">
            <h4 style="color: #a78bfa; margin-bottom: 8px;">üè¢ Vendors</h4>
            <form action="/import-vendors" method="post" enctype="multipart/form-data" style="margin-top: 12px;">
                <input type="file" name="file" accept=".csv" required style="margin-bottom: 8px; font-size: 13px;">
                <button type="submit" class="btn btn-small btn-primary">Upload</button>
            </form>
        </div>
        
        <div style="background: #1e293b; padding: 16px; border-radius: 8px; border: 2px solid #334155;">
            <h4 style="color: #6ee7b7; margin-bottom: 8px;">‚öôÔ∏è Manufacturing</h4>
            <form action="/import-manufacturing" method="post" enctype="multipart/form-data" style="margin-top: 12px;">
                <input type="file" name="file" accept=".csv" required style="margin-bottom: 8px; font-size: 13px;">
                <button type="submit" class="btn btn-small btn-primary">Upload</button>
            </form>
        </div>
    </div>
    <div style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 6px; border-left: 3px solid #3b82f6;">
        <p style="color: #cbd5e1; font-size: 13px; margin: 0;">
            <strong>CSV Format:</strong> Include headers matching the data fields. 
            <a href="/static/sample_procurement.csv" download style="color: #60a5fa; text-decoration: underline;">Download sample templates</a>
        </p>
    </div>
</section>

<section class="panel table-panel">
    <div class="panel-header">
        <h3>üìã Work Orders</h3>
        <p class="panel-subtitle">
            Latest 50 work orders across all departments
        </p>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Team</th>
                <th>Status</th>
                <th>Quantity</th>
                <th>Order Type</th>
                <th>Created At</th>
            </tr>
            </thead>
            <tbody>
            {% for o in orders %}
            <tr>
                <td><strong>{{ o.display_id or ('#' ~ o.id) }}</strong></td>
                <td title="{{ o.title }}"><strong>{{ o.title }}</strong></td>
                <td>
                    <span class="pill pill-role-{{ o.assigned_role.value }}">
                        {{ o.assigned_role|pretty }}
                    </span>
                </td>
                <td>
                    {% if o.status.value == 'blocked' %}
                        <div class="blocked-indicator">
                            <span class="pill pill-status-blocked">Blocked</span>
                            {% if o.blocked_reason %}
                            <span class="blocked-reason-tooltip" data-reason="{{ o.blocked_reason }}">
                                ‚ÑπÔ∏è
                            </span>
                            {% endif %}
                        </div>
                    {% else %}
                        <span class="pill pill-status-{{ o.status.value }}">
                            {{ o.status|pretty }}
                        </span>
                    {% endif %}
                </td>
                <td>
                    <strong>{{ o.quantity }}</strong>
                    <span class="muted">{{ o.unit }}</span>
                </td>
                <td>
                    <span class="pill pill-type-{{ o.order_type.value }}">
                        {{ o.order_type|pretty }}
                    </span>
                </td>
                <td>{{ o.created_at.strftime('%Y-%m-%d %H:%M') if o.created_at else '‚Äî' }}</td>
            </tr>
            {% endfor %}
            {% if not orders %}
            <tr>
                <td colspan="7" class="text-center">No work orders yet</td>
            </tr>
            {% endif %}
            </tbody>
        </table>
    </div>
</section>

<section class="panel">
    <div class="panel-header">
        <h3>üì¶ Procurement Requests from Manufacturing</h3>
        <p class="panel-subtitle">
            Requests raised by Manufacturing that require Procurement + Management review
        </p>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>Request ID</th>
                <th>Title</th>
                <th>Qty</th>
                <th>Unit</th>
                <th>Status</th>
                <th>Vendor</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for r in pending_reqs %}
            <tr>
                <td><strong>{{ r.display_id or ('#' ~ r.id) }}</strong></td>
                <td title="{{ r.title }}"><strong>{{ r.title }}</strong></td>
                <td><strong>{{ r.quantity }}</strong></td>
                <td>{{ r.unit }}</td>
                <td>
                    <span class="pill pill-status-new">{{ r.status|pretty }}</span>
                </td>
                <td>
                    <span class="muted">Select on approve</span>
                </td>
                <td>
                    <div class="action-buttons">
                        <form action="/procurement-request/{{ r.id }}/approve" method="post" class="inline-form">
                            <select name="vendor_id">
                                <option value="0">Choose vendor‚Ä¶</option>
                                {% for v in vendors %}
                                <option value="{{ v.id }}">{{ v.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-small btn-success">‚úì Approve</button>
                        </form>
                        <form action="/procurement-request/{{ r.id }}/reject" method="post" class="inline-form">
                            <button type="submit" class="btn btn-small btn-danger">‚úó Reject</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
            {% if not pending_reqs %}
            <tr>
                <td colspan="7" class="text-center">No pending requests from Manufacturing</td>
            </tr>
            {% endif %}
            </tbody>
        </table>
    </div>

    <div class="panel-footer">
        <p class="panel-subtitle">
            <strong>Updated Workflow:</strong>
            <span class="pill pill-role-procurement">Procurement</span>
            <span style="color: #64748b;">‚Üí</span>
            <span class="pill pill-role-inventory">Inventory (Raw)</span>
            <span style="color: #64748b; margin: 0 12px;">|</span>
            <span class="pill pill-role-manufacturing">Manufacturing</span>
            <span style="color: #64748b;">‚Üí</span>
            <span class="pill pill-role-qa">Quality</span>
            <span style="color: #64748b;">‚Üí</span>
            <span class="pill pill-role-packaging">Packaging</span>
            <span style="color: #64748b;">‚Üí</span>
            <span class="pill pill-role-inventory">Inventory (Delivery)</span>
        </p>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const roleSelect = document.getElementById('assigned_role');
    const vendorField = document.getElementById('vendor-field');
    const recipeField = document.getElementById('recipe-field');
    const categoryExisting = document.getElementById('category_existing');
    const categoryNew = document.getElementById('category_new');
    const titleField = document.getElementById('title-field');
    const descriptionField = document.getElementById('description-field');
    
    // NEW: Procurement order type elements
    const procurementTypeField = document.getElementById('procurement-type-field');
    const procRawRadio = document.getElementById('proc_raw');
    const procPackagingRadio = document.getElementById('proc_packaging');
    const packagingTypeField = document.getElementById('packaging-type-field');
    const packagingSizeField = document.getElementById('packaging-size-field');
    const packagingTypeSelect = document.getElementById('packaging_type');
    const packagingSizeSelect = document.getElementById('packaging_size');

    // Packaging size options
    const packagingSizes = {
        'Cardboard boxes': ['24 tubs', '48 tubs'],
        'Tubs': ['5gms', '10gms', '65gms'],
        'Pouches': ['65gms', '100gms', '150gms', '200gms', '250gms', '500gms', '1kg', '5kg', '10kg']
    };

    // Show/hide fields based on role
    function updateFieldsVisibility() {
        const role = roleSelect.value;
        
        // Show vendor field and procurement type only for procurement
        if (role === 'procurement') {
            vendorField.style.display = '';
            procurementTypeField.style.display = '';
            updateProcurementTypeFields();
        } else {
            vendorField.style.display = 'none';
            procurementTypeField.style.display = 'none';
            packagingTypeField.style.display = 'none';
            packagingSizeField.style.display = 'none';
        }
        
        // Show recipe field only for manufacturing
        if (role === 'manufacturing') {
            recipeField.style.display = '';
        } else {
            recipeField.style.display = 'none';
        }
    }

    // Show/hide packaging fields based on procurement order type
    function updateProcurementTypeFields() {
        if (procPackagingRadio.checked) {
            packagingTypeField.style.display = '';
            packagingSizeField.style.display = '';
        } else {
            packagingTypeField.style.display = 'none';
            packagingSizeField.style.display = 'none';
        }
    }

    // Update packaging size dropdown based on packaging type
    function updatePackagingSizeOptions() {
        const selectedType = packagingTypeSelect.value;
        packagingSizeSelect.innerHTML = '<option value="">Select Size</option>';
        
        if (selectedType && packagingSizes[selectedType]) {
            packagingSizes[selectedType].forEach(size => {
                const option = document.createElement('option');
                option.value = size;
                option.textContent = size;
                packagingSizeSelect.appendChild(option);
            });
        }
    }

    // Show/hide title and description based on order category
    function updateCategoryFields() {
        const isNew = categoryNew.checked;
        
        if (isNew) {
            titleField.style.display = '';
            descriptionField.style.display = '';
            // Make title required for new orders
            document.getElementById('title').required = true;
        } else {
            titleField.style.display = 'none';
            descriptionField.style.display = 'none';
            document.getElementById('title').required = false;
        }
    }

    roleSelect.addEventListener('change', updateFieldsVisibility);
    categoryExisting.addEventListener('change', updateCategoryFields);
    categoryNew.addEventListener('change', updateCategoryFields);
    procRawRadio.addEventListener('change', updateProcurementTypeFields);
    procPackagingRadio.addEventListener('change', updateProcurementTypeFields);
    packagingTypeSelect.addEventListener('change', updatePackagingSizeOptions);
    
    updateFieldsVisibility();
    updateCategoryFields();
});
</script>

{% endblock %}
